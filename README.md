[![Master branch PR merge pipeline](https://github.com/amb-code/amb-feedback-bot/actions/workflows/master.yml/badge.svg)](https://github.com/amb-code/amb-feedback-bot/actions/workflows/master.yml)

# AMB Feedback Bot

Telegram-бот для обратной связи команд.

На данный момент бот имеет следующие возможности:
- позволяет анонимно общаться с пользователями в Telegram
- диалог с каждым пользователем ведётся в отдельной теме
- выдача и снятие банов
- редактирование предыдущих сообщений
- управление историей чата: оператор чата может удалять сообщения пользователя 
  или свои собственные, либо полностью очистить историю чата со стороны 
  пользователя
- управление историей данных пользователя: бот уведомляет об изменении полного
  имени или имени пользователя, можно посмотреть полную историю изменений
- мониторинг ошибок через Sentry

Бот обратной связи представляет из себя тг-бота и тг-группой с темами, связанных друг с другом. В тг-бота пользователи пишут сообщения, а админы/редакция через тг-группу отвечают им. На каждого написавшего в тг-бота бот создает в тг-группе отдельную тему, в которой будет диалог только с этим человеком.

Инструкция по запуску бота обратной связи. С инструкцией справится любой пользователь, никакие специфические навыки не требуются. Внимательно читайте и делайте по порядку

А) Предварительная подготовка:

0. У вас есть компьютер/ноутбук с Windows

1. У какого-нибудь хостинга арендовать виртуальный сервер (VPS) с Ubuntu-22.04 или Ubuntu-24.04. VPS нужен для того, чтобы бот работал 24 часа в сутки. Шаги:
    * 1.1. выбрать хостинг
    * 1.2. регистрация на сайте хостинга
    * 1.3. выбрать сервер у хостинга (подойдет самый дешевый)
    * 1.4. оплатить сервер
    * 1.5. получить от хостинга 3 поля вашего арендованного сервера для подключения к нему (обычно после оплаты автоматически приходит информация на почту или в личный кабинет хостинга). Поля: server_ip, ssh_login (обычно это root или administranor) и ssh_password

2. Скачать и установить программу WinSCP для обмена файлами с сервером отсюда:
https://winscp.net/eng/download.php

3. Скачать и установить программу Putty для доступа к командной строке сервера отсюда:
https://www.putty.org

4. Создать тг-бота у https://t.me/BotFather . Пользователи будут отправлять в созданного тг-бота сообщения для вас. При создании BotFather пришлет «токен» (это строка из символов), сохраните его

5. Создать тг-группу. Группа — это «коллцентр», в который тг-бот будет пересылать сообщения пользователей и через который вы будете отправлять им ответы. Нужно узнать и сохранить ID созданной группы с помощью шагов:
    * 5.1. включите в группе «темы»/«топики» (Управление групой -> Темы -> Включить темы)
    * 5.2. выдайте себе возможноть отправлять сообщения от имени группы (Управление группой -> Администраторы -> Правой кнопкой на себя -> Изменить права -> Анонимность ВКЛ)
    * 5.3. напишите любое текстовое сообщение в топик «#General» от имени группы 
    * 5.4. перешлите свое сообщение от имени группы в бот https://t.me/TheGetAnyID_bot , он пришлет ID группы (это отрицательное число с 10-15 знаками), сохраните ID группы

6. Добавить тг-бота в тг-группу и сделать бота админом с правами «управлять темами» и «закреплять сообщения» (управление группой -> администраторы -> правой кнопкой на бота -> изменить права)

Б) Настройка сервера:

0. Вы сделали все пункты из предворительной подготовки. У вас есть 5 полей:
    * server_ip
    * ssh_login
    * ssh_password
    * token тг-бота
    * ID тг-группы «коллцентра»

1. Подключиться к арендованному серверу через программу Putty с помощью шагов:
    * 1.1. Запустите PuTTY
    * 1.2. Ведите IP-адрес сервера: server_ip
    * 1.3. Проверьте, что «Port» указан 22
    * 1.4. Проверьте, что «Connection type» выбран SSH.
    * 1.5. Нажмите кнопку «Open»
    * 1.6. При первом подключении появится окно про ключ шифрования, нажмите «Accept»
    * 1.7. Откроется окно терминала с предложением ввести логин: login as: введите ssh_login и нажмите клавишу «Enter».
    * 1.8. Даллее запросит password: введите пароль ssh_password. Пароль можно вводить не посимвольно руками, а скопировать, в активном окне терминала нажать правую кнопку мыши — он вставится в терминал. Введённые/Вставленные символы не отображаются, после окончания ввода нажмите клавишу «Enter».
    * 1.9. Если логин и пароль введены верно, то вход на сервер будет успешным, а в окне PuTTY появится приветственное сообщение и откроется возможность ввода команд

2. Далее ввести команды. Каждая следующая команда отправляется только после выполнения сервером предыдущей:
    * установить docker командой: curl https://get.docker.com | sh
    * выдаем права командой: useradd -m -g docker docker
    * переходим в папку командой: cd /home/docker
    * скачиваем код на сервер командой: git clone https://github.com/amb-code/amb-feedback-bot-minst.git amb-feedback-bot
    * выдаем права командой: chown -R 1000:100 /home/docker/amb-feedback-bot
    * можно закрыть PuTTY

3. Чтобы бот работал, в его параметры нужно записать токен вашего тг-бота, ID группы-коллцентра и отправить параметры на сервер с помощью шагов: 
    * скачать файл bot.env отсюда: https://github.com/amb-code/amb-feedback-bot-minst/blob/main/env/bot.env (там есть кнопка «Download raw file» со стрелочкой на ее иконке)
    * открыть его в любом тектовом редакторе (Notepad++, Блокнот, WordPad, MicrosoftWord и др)
    * в поле «TG_TOKEN=» вместо «88005553535:KRYsdE8DSVL12ur1RfMaxLLWYhQ_idRT» записать токен вашего тг бота
    * в поле «TG_CHAT_ID=» вместо «-1001234567890» записать ID вашей группы (также с минусом).
    * сохранить изменения в файле bot.env (проверьте, что файл также называется bot и имеет расширение .env)
    * подключиться к серверу через программу winSCP (при подключении проверить протокол передачи: SFTP, Порт : 22, Имя хоста:  server_ip, Имя пользователя: ssh_login, Пароль: ssh_password)
    * при успешном подключении откроется окно, в левой части будут директории вашего компьютера, в правой - директории удаленного сервера.
    * в левой части нужно перейти в папку, где хранится новая исправленная вами версия bot.env . В правой части нужно перейти в папку на сервере /home/docker/amb-feedback-bot/env/ , где хранится старая версия файла bot.env 
    * перетащить отредактированный файл bot.env из левой части окна в правую, согласиться на перезапись этого файла на сервере
    * закрыть winSCP

В) Запуск и перезапуск бота

0. Ранее вы сделали все пункты из А) Предварительной подготовки и Б) Настройки сервера

1. Подключиться к серверу через программу PuTTY

2. Перейти в папку командой: cd /home/docker/amb-feedback-bot

3*. (Пропустить этот пункт при первом запуске бота) Если ранее бот был запущен и вы хотите перезапустить, то предварительно введите команду для его выключения: docker compose down

4. Введите команду для запуска: docker compose up -d

5. Бот запущен. Проверить логи бота, чтобы в них не было никаких ошибок и последняя строчка в логах была «... INFO ... POST-INIT: Bot ready, listening...», командой: docker compose logs feedback-bot

6. Можно закрыть PuTTY

7. Протестировать работу всех функции через тг-бота и тг-группу
