[![Master branch PR merge pipeline](https://github.com/amb-code/amb-feedback-bot/actions/workflows/master.yml/badge.svg)](https://github.com/amb-code/amb-feedback-bot/actions/workflows/master.yml)

# AMB Feedback Bot

Telegram-бот для обратной связи команд.

На данный момент бот имеет следующие возможности:
- позволяет анонимно общаться с пользователями в Telegram
- диалог с каждым пользователем ведётся в отдельной теме
- выдача и снятие банов
- редактирование предыдущих сообщений
- управление историей чата: оператор чата может удалять сообщения пользователя 
  или свои собственные, либо полностью очистить историю чата со стороны 
  пользователя
- управление историей данных пользователя: бот уведомляет об изменении полного
  имени или имени пользователя, можно посмотреть полную историю изменений
- мониторинг ошибок через Sentry

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**  *generated with [DocToc](https://github.com/thlorenz/doctoc)*
<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## Инструкция по установке бота
Перейдем сразу к делу. Данная инструкция предназначена для пользователей, **не 
обладающих** опытом разработки и развертывания программного обеспечения. Мы 
старались ее настолько простой, насколько это возможно, чтобы команды, которые 
не могут позволить себе услуги дорогостоящих специалистов, могли развернуть бот
самостоятельно. Поэтому заварите себе кофе, сделайте глубокий вдох, и начнем.

### Аренда сервера
Первое, что нам понадобится – это сервер, на котором будет крутиться бот. Бот не
требователен, и дорогая машина нам не понадобится. Мы будем использовать хостинг
[Beget](https://beget.com). На момент написания самый дешевй сервер стоил 219 
рублей в месяц. 

1. Пройдите регистрацию, создайте аккаунт и зайдите в контрольную панель 
   [здесь](https://beget.com/ru). После входа в слева вы увидите кнопку 
   `Create`. Нажмите на нее, выпадет список, где нужно будет выбрать
   `Virtual server`:

   ![create_server](./docs/create_server.png)

2. Выберите регион и тип сервера. Нам подойдет самый дешевый. Регион на ваше 
   усмотрение.

   ![choose_region_type](./docs/choose_region_type.png)

3. В качестве системы выберите Docker.

   ![choose_image](./docs/choose_image.png)

4. Затем в разделе `Authentication` Нужно будет развернуть пункты `Set passowrd`
   и `Additional server parameters`.

   ![choose_auth1](./docs/choose_auth1.png)

   Должно получиться что-то такое. Поле пароля будет заполнено автоматически. 
   Запишите его и не потеряйте. В качестве имени (Virtual server name) можете 
   ввести что угодно, но вполне подойдет `feedback-bot`, если вы не собираетесь
   использовать этот сервер для чего-либо еще.

   ![choose_auth2](./docs/choose_auth2.png)

5. Готово, нажимаем кнопку `Create virtual server`. Слева на панели появился 
   только что созданный нами сервер, а справа можно будет увидеть подробности. 
   Обратите внимание на кнопки `Terminal` и `File manager`, она нам понадобится 
   на следующем шаге. 

   ![server_created](./docs/server_created.png)


### Заходим на сервер и подготавливаем его
Теперь нам нужно подготовить сервер для работы бота. Нам потребуется пароль, 
который мы записали на прошлом шаге.

1. Теперь пора нажать на кнопку `Terminal`. Откроется окно терминала. 
   В качестве логина вводим `root`.  Затем пароль, который мы записали на 
   предыдущем шаге. Если все прошло успешно, вы увидите что-то такое

   ![login_successful](./docs/login_successful.png)

2. Сейчас мы добавим пользователя для `Docker`. От его имени будет запускаться 
   приложение. Вводите команду не спеша. Если вы все сделали правильно, терминал
   ничего не ответит. Иначе вы увидите ошибку.

   ```
   useradd -m -g docker docker
   ```


### Развертывание бота
Приготовьтесь, это самая муторная часть.

1. Перейдем в домашнюю папку пользователя, которого мы только что создали.

   ```
   cd /home/docker
   ```

2. Теперь нужно скопировать код бота. Нам нужна лишь небольшая часть этих 
   файлов, но для простоты мы скопируем все. Вы увидите что-то такое.

   ```
   git clone https://github.com/amb-code/amb-feedback-bot.git
   ```

   Если все в порядке, вы увидите что-то такое:

   ![clone_repo](./docs/clone_repo.png)

3. Зайдем в только что скопированную папку:

   ```
   cd amb-feedback-bot
   ```

4. Создадим файл окружения для `Docker Compose`. Это нужно, чтобы докер смог 
   найти нужную версию бота. Последнюю версию боту вы всегда можете проверить на 
   [странице репозитория](https://github.com/amb-code/amb-feedback-bot#), открыв
   выпадающее меню в верхней части страницы и перейдя в раздел `Tags`.

   ```
   nano .env
   ```
   Откроется окно редактора `nano`. Введите следующее содержание. Версию нужно 
   указать без `v`. То есть, если на странице репозитория она `v1.0.0`, то вы 
   пишите просто `1.0.0`. Должно получиться что-то такое:
   ```
   TAG=1.0.0
   ```
   Нажмите ctrl-x для выхода, ответьте `y` на вопрос, сохранить ли файл. 
   Подтвердите имя для сохранения, оно уже правильное, менять его не надо.

5. Теперь создадим папку `env`, в которой будут лежать уже переменные самого 
   бота. Это более сложная задача, поскольку вводит руками длинные ключи будет 
   сложно, долго, но главное – ненадежно. Поэтому мы создадим их у вас на 
   компьютере, и загрузим через файловый менеджер панели управления Beget.

   ```
   mkdir env
   cd env
   ```

6. Создадим сами файлы с переменными. Откройте ХХХХХХЪ, который вы поставили в
   начале этого руководства, настал его звездный час.

   Создайте новый файл, заполните содержание

   ```dotenv
   SETTINGS_MODULE=feedbackbot.settings
   DB_USERNAME=postgres
   DB_PASSWORD=postgres
   DB_HOST=postgres
   DB_PORT=5432
   DB_NAME=feedback_bot
   TG_TOKEN=<токен бота, который вы получили в начале>
   TG_CHAT_ID=<идентификатор чата, что-то такое -1234567890123>
   TG_BOT_USERNAME=<имя, которые вы вабрали при регистрации бота>
   ```
   Сохраните на рабоем столе под именем `bot.env`.

   Теперь воздадим `db.env`:
   ```dotenv
   POSTGRES_USER=postgres
   POSTGRES_DB=feedback_bot
   POSTGRES_PASSWORD=postgres
   POSTGRES_HOST=postgres
   POSTGRES_PORT=5432
   ```

7. Сейчас мы загрузим эти файлы в папку `env`, которую создали выше. В шаге 5 
   раздела [Аренда сервера]() мы обращали внимание на кнопку `File manager`. 
   Настало время ее нажать. Откроется файловый менеджер с доступом к диску 
   сервера. Вам нужно будет пройти по пути 
   `home > docker > amb-feedback-bot > env` и нажать кнопку `Загрущить файлы`.
   Затем выберите два файла, что вы создали ранее и загрузите. Если вы все 
   сделали правильно, результат должен выглядеть вот так:

   ![upload_env_files](./docs/upload_env_files.png)

8. Теперь настроим разрешения, необходимые боту для работы. Эта команда настроит
   владельца и и группу директории бота.

   ```
   chown -R 1000:100 /home/docker/amb-feedback-bot
   ```

9. Теперь запустим бот и проверим, все ли в порядке

   ```
   cd home/docker/amb-feedback-bot
   docker compose up -d
   docker compose logs feedback-bot
   ```

   В результате выполнения двух последних команд вы должны увидеть что-то такое.

   ![docker_up_logs](./docs/docker_up_logs.png)

   Если логи бот в конце говорит `Bot ready, listening...`, щначит вы все 
   сделали правильно, и пора проверить работоспособность бота.












## Запуск бота

### Предварительные требования Telegram

Для запуска бота вам необходимо выполнить следующее в Telegram:

- Токен бота, который вы получили от [@BotFather](https://t.me/BotFather) при создании бота
- Создать приватную группу
- Получить ID чата: [как получить ID группового чата](https://stackoverflow.com/questions/32423837/telegram-bot-how-to-get-a-group-chat-id)
- Добавить бота в чат
- Выдать ему необходимые разрешения

  ![required_permissions](./docs/bot_premissions.png)

### Включение мониторинга 

Опционально: создать проект Sentry и получить Sentry DSN. Однако это не
обязательно для запуска бота. 

### Запуск с docker compose
- клонировать репозиторий
- создать `db.env` из [db.env.example](env/db.env.example)
- создать `bot.env` из [bot.env.example](env/bot.env.example), используя значения
  из предыдущих шагов 
- запустить `docker compose up -d`


## Локальная разработка

Рекомендуемый способ — использовать virtualenv. Обратите внимание, что соглашения
проекта предполагают хранение venv внутри корня VCS.

Клонировать репозиторий:

    $ git clone git@github.com:amb-code/amb-feedback-bot.git

Создать окружение:

    $ cd amb-feedback-bot
    $ virtualenv -p python3 venv

Установить пакеты для разработки:

    $ source venv/bin/activate
    $ pip install -r requirements.txt
    $ pip install -r requirements-dev.txt

Создать файл .env из [.env.example](.env.example).

Запустить сервер разработки:

    $ python main.py 


## Процесс релиза

- создать feature-ветку
- обновить код и тесты
- открыть PR
- убедиться, что ветка успешно задеплоена, юнит- и интеграционные
  тесты проходят
- смержить PR
